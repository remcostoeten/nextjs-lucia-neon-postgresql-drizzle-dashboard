import { redirect } from 'next/navigation'
import { DrizzleAdapter } from '@auth/drizzle-adapter'
import { eq } from 'drizzle-orm'
import NextAuth from 'next-auth'

import { authConfig } from '@/config/auth'
import { DEFAULT_LOGIN_REDIRECT } from '@/config/routes'
import { db } from './db'
import { users } from './db/schema'

export const { handlers, auth, signIn, signOut } = NextAuth({
	...authConfig,

	adapter: DrizzleAdapter(db),

	session: {
		strategy: 'jwt'
	},

	pages: {
		signIn: '/login',
		newUser: '/signup'
	},

	events: {
		linkAccount: async ({ user }) => {
			await db
				.update(users)
				.set({ emailVerified: new Date() })
				.where(eq(users.id, user.id!))
		}
	},

	callbacks: {
		session: async ({ session, token }) => {
			if (token.sub && session.user) {
				session.user.id = token.sub
				session.user.username = token.username
			}

			return session
		},

		jwt: async ({ token }) => {
			const user = await db.query.users.findFirst({
				where: (u, { eq }) => eq(u.id, token.sub!)
			})

			if (user) {
				token.username = user.username
			}

			return token
		},

		redirect: () => DEFAULT_LOGIN_REDIRECT
	}
})

/**
 * Gets the current user from the server session
 *
 * @returns The current user
 */
export const getCurrentUser = async () => {
	const session = await auth()
	return session?.user
}

/**
 * Checks if the current user is authenticated
 * If not, redirects to the login page
 */
export const checkAuth = async () => {
	const session = await auth()
	if (!session) redirect('/login')
}
